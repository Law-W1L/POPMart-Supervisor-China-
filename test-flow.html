<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»ŸåŠŸèƒ½æµ‹è¯• - Popmartç›‘æ§</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { border-color: #28a745; background: #d4edda; color: #155724; }
        .error { border-color: #dc3545; background: #f8d7da; color: #721c24; }
        .device-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .jump-simulation {
            border: 2px dashed #007bff;
            padding: 20px;
            text-align: center;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Popmartç›‘æ§ç³»ç»ŸåŠŸèƒ½æµ‹è¯•</h1>
    
    <!-- è®¾å¤‡ä¿¡æ¯ -->
    <div class="test-section">
        <h2>ğŸ“± è®¾å¤‡æ£€æµ‹</h2>
        <div class="device-info" id="deviceInfo">æ£€æµ‹ä¸­...</div>
    </div>
    
    <!-- æµ‹è¯•1ï¼šåˆ›å»ºè™šæ‹Ÿæ–°å“ -->
    <div class="test-section">
        <h2>ğŸ”„ æµ‹è¯•1ï¼šåˆ›å»ºè™šæ‹Ÿæ–°å“</h2>
        <button class="test-button" onclick="triggerDiscovery()">è§¦å‘æ–°å“å‘ç°</button>
        <div class="result" id="discovery-result">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <!-- æµ‹è¯•2ï¼šè·å–æ–°å“åˆ—è¡¨ -->
    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•2ï¼šè·å–æ–°å“åˆ—è¡¨</h2>
        <button class="test-button" onclick="getProducts()">è·å–å‘ç°çš„æ–°å“</button>
        <div class="result" id="products-result">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <!-- æµ‹è¯•3ï¼šæ¨¡æ‹Ÿç§»åŠ¨ç«¯è´­ä¹° -->
    <div class="test-section">
        <h2>ğŸ›’ æµ‹è¯•3ï¼šæ¨¡æ‹Ÿç§»åŠ¨ç«¯è´­ä¹°</h2>
        <button class="test-button" onclick="simulatePurchase()">æ¨¡æ‹Ÿå¿«é€Ÿè´­ä¹°</button>
        <div class="result" id="purchase-result">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <!-- æµ‹è¯•4ï¼šè·³è½¬é€»è¾‘éªŒè¯ -->
    <div class="test-section">
        <h2>ğŸš€ æµ‹è¯•4ï¼šè·³è½¬é€»è¾‘éªŒè¯</h2>
        <div class="jump-simulation">
            <h3>æ¨¡æ‹Ÿè·³è½¬åœºæ™¯</h3>
            <button class="test-button" onclick="simulateJump('miniprogram')">æ¨¡æ‹Ÿå°ç¨‹åºè·³è½¬</button>
            <button class="test-button" onclick="simulateJump('h5')">æ¨¡æ‹ŸH5è·³è½¬</button>
            <button class="test-button" onclick="simulateJump('wechatpay')">æ¨¡æ‹Ÿå¾®ä¿¡æ”¯ä»˜è·³è½¬</button>
        </div>
        <div class="result" id="jump-result">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <!-- æµ‹è¯•5ï¼šå®Œæ•´æµç¨‹æ¨¡æ‹Ÿ -->
    <div class="test-section">
        <h2>âš¡ æµ‹è¯•5ï¼šå®Œæ•´æµç¨‹æ¨¡æ‹Ÿ</h2>
        <button class="test-button" onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <div class="result" id="full-test-result">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <script>
        // è®¾å¤‡æ£€æµ‹
        const DeviceDetector = {
            isMobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            isWeChat: /MicroMessenger/i.test(navigator.userAgent),
            isIOS: /iPhone|iPad|iPod/i.test(navigator.userAgent),
            isAndroid: /Android/i.test(navigator.userAgent)
        };
        
        // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
        function showDeviceInfo() {
            const info = `
è®¾å¤‡ç±»å‹: ${DeviceDetector.isMobile ? 'ç§»åŠ¨è®¾å¤‡' : 'PCè®¾å¤‡'}
å¾®ä¿¡ç¯å¢ƒ: ${DeviceDetector.isWeChat ? 'æ˜¯' : 'å¦'}
iOSè®¾å¤‡: ${DeviceDetector.isIOS ? 'æ˜¯' : 'å¦'}
Androidè®¾å¤‡: ${DeviceDetector.isAndroid ? 'æ˜¯' : 'å¦'}
ç”¨æˆ·ä»£ç†: ${navigator.userAgent}
            `;
            document.getElementById('deviceInfo').textContent = info;
        }
        
        // æµ‹è¯•1ï¼šè§¦å‘æ–°å“å‘ç°
        async function triggerDiscovery() {
            const resultDiv = document.getElementById('discovery-result');
            resultDiv.textContent = 'æ­£åœ¨è§¦å‘æ–°å“å‘ç°...';
            
            try {
                const response = await fetch('/api/trigger-discovery', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… æˆåŠŸï¼\n${JSON.stringify(result, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ å¤±è´¥ï¼š${error.message}`;
            }
        }
        
        // æµ‹è¯•2ï¼šè·å–æ–°å“åˆ—è¡¨
        async function getProducts() {
            const resultDiv = document.getElementById('products-result');
            resultDiv.textContent = 'æ­£åœ¨è·å–æ–°å“åˆ—è¡¨...';
            
            try {
                const response = await fetch('/api/discovered-products');
                const result = await response.json();
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… è·å–æˆåŠŸï¼å‘ç° ${result.data.count} ä¸ªæ–°å“\n${JSON.stringify(result, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ å¤±è´¥ï¼š${error.message}`;
            }
        }
        
        // æµ‹è¯•3ï¼šæ¨¡æ‹Ÿç§»åŠ¨ç«¯è´­ä¹°
        async function simulatePurchase() {
            const resultDiv = document.getElementById('purchase-result');
            resultDiv.textContent = 'æ­£åœ¨æ¨¡æ‹Ÿç§»åŠ¨ç«¯è´­ä¹°...';
            
            try {
                const response = await fetch('/api/mobile/quick-purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: 'test_molly_space_001',
                        productName: 'MOLLY Space Series'
                    })
                });
                
                const result = await response.json();
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… è´­ä¹°æ¨¡æ‹ŸæˆåŠŸï¼\n${JSON.stringify(result, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ è´­ä¹°å¤±è´¥ï¼š${error.message}`;
            }
        }
        
        // æµ‹è¯•4ï¼šè·³è½¬é€»è¾‘éªŒè¯
        function simulateJump(type) {
            const resultDiv = document.getElementById('jump-result');
            let message = '';
            
            switch(type) {
                case 'miniprogram':
                    message = `ğŸ”„ æ¨¡æ‹Ÿå°ç¨‹åºè·³è½¬
è®¾å¤‡æ£€æµ‹: ${DeviceDetector.isMobile ? 'ç§»åŠ¨è®¾å¤‡' : 'PCè®¾å¤‡'}
å¾®ä¿¡ç¯å¢ƒ: ${DeviceDetector.isWeChat ? 'æ˜¯' : 'å¦'}
è·³è½¬ç­–ç•¥: ${DeviceDetector.isWeChat && DeviceDetector.isMobile ? 
'ç›´æ¥è·³è½¬å°ç¨‹åº' : 'å¼•å¯¼æ‰“å¼€å¾®ä¿¡'}
è·³è½¬URL: weixin://dl/business/?businessType=9&appid=wx633d41b25e0fabf4&pagepath=pages/goods/detail?id=test_123`;
                    break;
                    
                case 'h5':
                    message = `ğŸŒ æ¨¡æ‹ŸH5é¡µé¢è·³è½¬
è®¾å¤‡ç±»å‹: ${DeviceDetector.isMobile ? 'ç§»åŠ¨è®¾å¤‡' : 'PCè®¾å¤‡'}
è·³è½¬ç­–ç•¥: ${DeviceDetector.isMobile ? 'ç›´æ¥è·³è½¬' : 'æ–°çª—å£æ‰“å¼€'}
è·³è½¬URL: https://popmart.com/product/test_123?from=monitor`;
                    break;
                    
                case 'wechatpay':
                    message = `ğŸ’° æ¨¡æ‹Ÿå¾®ä¿¡æ”¯ä»˜è·³è½¬
æ”¯ä»˜ç±»å‹: ç§»åŠ¨ç«¯ç½‘é¡µæ”¯ä»˜
è·³è½¬ç­–ç•¥: ç›´æ¥è·³è½¬å¾®ä¿¡æ”¯ä»˜é¡µé¢
æ”¯ä»˜URL: https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=mock_prepay_id_${Date.now()}`;
                    break;
            }
            
            resultDiv.className = 'result success';
            resultDiv.textContent = message;
        }
        
        // æµ‹è¯•5ï¼šå®Œæ•´æµç¨‹æ¨¡æ‹Ÿ
        async function runFullTest() {
            const resultDiv = document.getElementById('full-test-result');
            resultDiv.textContent = 'å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...\n';
            
            try {
                // æ­¥éª¤1ï¼šè§¦å‘æ–°å“å‘ç°
                resultDiv.textContent += 'æ­¥éª¤1: è§¦å‘æ–°å“å‘ç°...\n';
                const discoveryResponse = await fetch('/api/trigger-discovery', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const discoveryResult = await discoveryResponse.json();
                resultDiv.textContent += `âœ… æ–°å“å‘ç°æˆåŠŸ: ${discoveryResult.data.name}\n\n`;
                
                // æ­¥éª¤2ï¼šè·å–æ–°å“åˆ—è¡¨
                resultDiv.textContent += 'æ­¥éª¤2: è·å–æ–°å“åˆ—è¡¨...\n';
                const productsResponse = await fetch('/api/discovered-products');
                const productsResult = await productsResponse.json();
                resultDiv.textContent += `âœ… è·å–åˆ° ${productsResult.data.count} ä¸ªæ–°å“\n\n`;
                
                // æ­¥éª¤3ï¼šæ¨¡æ‹Ÿæ‰‹æœºæ”¶åˆ°æ¨é€
                resultDiv.textContent += 'æ­¥éª¤3: æ¨¡æ‹Ÿæ‰‹æœºæ”¶åˆ°æ¨é€é€šçŸ¥...\n';
                resultDiv.textContent += `ğŸ“± æ¨é€å†…å®¹: "ğŸ”¥ æ³¡æ³¡é©¬ç‰¹æ–°å“ä¸Šæ¶ï¼${discoveryResult.data.name}"\n\n`;
                
                // æ­¥éª¤4ï¼šæ¨¡æ‹Ÿç”¨æˆ·ç‚¹å‡»è´­ä¹°
                resultDiv.textContent += 'æ­¥éª¤4: æ¨¡æ‹Ÿç”¨æˆ·ç‚¹å‡»è´­ä¹°...\n';
                const purchaseResponse = await fetch('/api/mobile/quick-purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: discoveryResult.data.id,
                        productName: discoveryResult.data.name
                    })
                });
                const purchaseResult = await purchaseResponse.json();
                resultDiv.textContent += `âœ… è®¢å•åˆ›å»ºæˆåŠŸ: ${purchaseResult.data.orderId}\n\n`;
                
                // æ­¥éª¤5ï¼šæ¨¡æ‹Ÿè·³è½¬åˆ°æ”¯ä»˜é¡µé¢
                resultDiv.textContent += 'æ­¥éª¤5: æ¨¡æ‹Ÿè·³è½¬åˆ°æ”¯ä»˜é¡µé¢...\n';
                resultDiv.textContent += `ğŸš€ æ”¯ä»˜è·³è½¬: ${purchaseResult.data.wechatPayUrl}\n\n`;
                
                resultDiv.textContent += 'ğŸ‰ å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸï¼ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼\n';
                resultDiv.textContent += '\n=== æµ‹è¯•æ€»ç»“ ===\n';
                resultDiv.textContent += 'âœ… æ–°å“ç›‘æ§ï¼šæ­£å¸¸\n';
                resultDiv.textContent += 'âœ… æ•°æ®å­˜å‚¨ï¼šæ­£å¸¸\n';
                resultDiv.textContent += 'âœ… ç§»åŠ¨ç«¯APIï¼šæ­£å¸¸\n';
                resultDiv.textContent += 'âœ… è´­ä¹°æµç¨‹ï¼šæ­£å¸¸\n';
                resultDiv.textContent += 'âœ… æ”¯ä»˜è·³è½¬ï¼šæ­£å¸¸\n';
                
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent += `âŒ æµ‹è¯•å¤±è´¥ï¼š${error.message}`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
        window.onload = function() {
            showDeviceInfo();
        };
    </script>
</body>
</html> 